
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    

    <title>Testing Guidelines &mdash; Astropy v0.2.1</title>
<!-- RTD <head> -->
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript" src="//media.readthedocs.org/javascript/underscore.js"></script>
<script type="text/javascript" src="//media.readthedocs.org/javascript/doctools.js"></script>

<script type="text/javascript">
  // This is included here for Javascript that doesn't have access to the templates.
  var doc_version = "v0.2.1";
  var doc_slug = "astropy";
</script>

<script type="text/javascript" src="//media.readthedocs.org/javascript/rtd.js"></script>
<!-- end RTD <head> -->

    
    <link rel="stylesheet" href="../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../_static/astropy_logo.ico"/>
    <link rel="top" title="Astropy v0.2.1" href="../index.html" />
    <link rel="next" title="Building, Cython/C Extensions, and Releasing" href="building_packaging.html" />
    <link rel="prev" title="Documentation Guidelines" href="docguide.html" /> 
  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"></a>
  <ul>
    <li><a class="homelink" title="AstroPy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../genindex.html">Index</a></li>
    <li><a title="Python Module Index" href="../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="building_packaging.html" title="Building, Cython/C Extensions, and Releasing">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="docguide.html" title="Documentation Guidelines">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../index.html">Astropy v0.2.1</a>
	 &raquo;
      </li>
      
      <li>Testing Guidelines</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="testing-guidelines">
<span id="id1"></span><h1>Testing Guidelines<a class="headerlink" href="#testing-guidelines" title="Permalink to this headline">¶</a></h1>
<p>This section describes the testing framework and format standards for tests in
Astropy core packages (this also serves as recommendations for affiliated
packages).</p>
<div class="section" id="testing-framework">
<h2>Testing Framework<a class="headerlink" href="#testing-framework" title="Permalink to this headline">¶</a></h2>
<p>The testing framework used by Astropy is the <a class="reference external" href="http://pytest.org/latest/">py.test</a>
framework.</p>
</div>
<div class="section" id="running-tests">
<span id="id2"></span><h2>Running Tests<a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h2>
<p>There are currently three different ways to invoke Astropy tests. Each method
invokes py.test to run the tests but offers different options when calling.</p>
<p>In addition to running the Astropy tests, these methods can also be called so
that they check Python source code for
<a class="reference external" href="http://www.python.org/dev/peps/pep-0008/">PEP8 compliance</a>. All of the PEP8
testing options require the
<a class="reference external" href="http://pypi.python.org/pypi/pytest-pep8">pytest-pep8 plugin</a>, which must be
installed separately.</p>
<div class="section" id="setup-py-test">
<h3>setup.py test<a class="headerlink" href="#setup-py-test" title="Permalink to this headline">¶</a></h3>
<p>The safest way to run the astropy test suite is via the setup command <tt class="docutils literal"><span class="pre">test</span></tt>.
This is invoked by running <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">test</span></tt> while in the astropy source
code directory. Run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">test</span> <span class="pre">--help</span></tt> to see the options to the
test command.</p>
<p>Turn on PEP8 checking by passing <tt class="docutils literal"><span class="pre">--pep8</span></tt> to the <tt class="docutils literal"><span class="pre">test</span></tt> command. This will
turn off regular testing and enable PEP8 testing.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This method of running the tests defaults to the version of <tt class="xref py py-obj docutils literal"><span class="pre">py.test</span></tt> that
is bundled with Astropy. To use the locally-installed version, you can set
the <tt class="docutils literal"><span class="pre">ASTROPY_USE_SYSTEM_PYTEST</span></tt> environment variable, eg.:</p>
<div class="last highlight-python"><pre>&gt; ASTROPY_USE_SYSTEM_PYTEST=1 python setup.py test</pre>
</div>
</div>
</div>
<div class="section" id="id3">
<h3>py.test<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>An alternative way to run tests from the command line is to switch to the source
code directory of astropy and simply type:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">py</span><span class="o">.</span><span class="n">test</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">py.test</span></tt> will look for files that <a class="reference external" href="http://pytest.org/latest/goodpractises.html#conventions-for-python-test-discovery">look like tests</a>
in the currect directory and all recursive directories then run all the code that
<a class="reference external" href="http://pytest.org/latest/goodpractises.html#conventions-for-python-test-discovery">looks like tests</a>
within those files.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To test any compiled C/Cython extensions, you must run <tt class="docutils literal"><span class="pre">python</span>
<span class="pre">setup.py</span> <span class="pre">develop</span></tt> prior to running the py.test command-line
script.  Otherwise, any tests that make use of these extensions
will not succeed.  Similarly, in python 3, these tests will not
run correctly in the source code, because they need the <tt class="docutils literal"><span class="pre">2to3</span></tt>
tool to be run on them.</p>
</div>
<p>You may specify a specific test file or directory at the command line:</p>
<div class="highlight-python"><pre>py.test test_file.py</pre>
</div>
<p>To run a specific test within a file use the <tt class="docutils literal"><span class="pre">-k</span></tt> option:</p>
<div class="highlight-python"><pre>py.test test_file.py -k "test_function"</pre>
</div>
<p>You may also use the <tt class="docutils literal"><span class="pre">-k</span></tt> option to not run tests py putting a <tt class="docutils literal"><span class="pre">-</span></tt> in front
of the matching string:</p>
<div class="highlight-python"><pre>py.test test_file.py -k "-test_function"</pre>
</div>
<p>py.test has a number of <a class="reference external" href="http://pytest.org/latest/usage.html">command line usage options.</a></p>
<p>Turn on PEP8 testing by adding the <tt class="docutils literal"><span class="pre">--pep8</span></tt> flag to the <tt class="docutils literal"><span class="pre">py.test</span></tt> call. By
default regular tests will also be run but these can be turned off by adding
<tt class="docutils literal"><span class="pre">-k</span> <span class="pre">pep8</span></tt>:</p>
<div class="highlight-python"><pre>py.test some_dir --pep8 -k pep8</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This method of running the tests uses the locally-installed version of
<tt class="xref py py-obj docutils literal"><span class="pre">py.test</span></tt> rather than the bundled one, and hence will fail if the local
version it is not up-to-date enough (<tt class="xref py py-obj docutils literal"><span class="pre">py.test</span></tt> 2.2 as of this writing).</p>
</div>
</div>
<div class="section" id="astropy-test">
<h3>astropy.test()<a class="headerlink" href="#astropy-test" title="Permalink to this headline">¶</a></h3>
<p>AstroPy includes a standalone version of py.test that allows to tests
to be run even if py.test is not installed. Tests can be run from within
AstroPy with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">astropy</span>
<span class="n">astropy</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<p>This will run all the default tests for AstroPy.</p>
<p>Tests for a specific package can be run by specifying the package in the call
to the <tt class="docutils literal"><span class="pre">test()</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">astropy</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s">&#39;io.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This method works only with package names that can be mapped to Astropy
directories. As an alternative you can test a specific directory or file
with the <tt class="docutils literal"><span class="pre">test_path</span></tt> option:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">astropy</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">test_path</span><span class="o">=</span><span class="s">&#39;wcs/tests/test_wcs.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">test_path</span></tt> must be specified either relative to the working directory
or absolutely.</p>
<p>By default <tt class="docutils literal"><span class="pre">astropy.test()</span></tt> will skip tests which retrieve data from the
internet. To turn these tests on use the <tt class="docutils literal"><span class="pre">remote_data</span></tt> flag:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">astropy</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s">&#39;io.fits&#39;</span><span class="p">,</span> <span class="n">remote_data</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>In addition, the <tt class="docutils literal"><span class="pre">test</span></tt> function supports any of the options that can be
passed to <a class="reference external" href="http://pytest.org/latest/builtin.html#pytest.main">pytest.main()</a>,
and convenience options <tt class="docutils literal"><span class="pre">verbose=</span></tt>, <tt class="docutils literal"><span class="pre">pastebin=</span></tt> and <tt class="docutils literal"><span class="pre">coverage=</span></tt>.</p>
<p>Enable PEP8 compliance testing with <tt class="docutils literal"><span class="pre">pep8=True</span></tt> in the call to
<tt class="docutils literal"><span class="pre">astropy.test</span></tt>. This will enable PEP8 checking and disable regular tests.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This method of running the tests defaults to the version of
<tt class="xref py py-obj docutils literal"><span class="pre">py.test</span></tt> that is bundled with Astropy. To use the locally-installed
version, you should set the <tt class="docutils literal"><span class="pre">ASTROPY_USE_SYSTEM_PYTEST</span></tt> environment
variable (see <a class="reference internal" href="../configs/index.html"><em>Configuration system (astropy.config)</em></a>) or the <tt class="xref py py-obj docutils literal"><span class="pre">py.test</span></tt> method described
above.</p>
</div>
</div>
</div>
<div class="section" id="regression-tests">
<h2>Regression tests<a class="headerlink" href="#regression-tests" title="Permalink to this headline">¶</a></h2>
<p>Any time a bug is fixed, and wherever possible, one or more regression tests
should be added to ensure that the bug is not introduced in future. Regression
tests should include the ticket URL where the bug was reported.</p>
</div>
<div class="section" id="where-to-put-tests">
<h2>Where to put tests<a class="headerlink" href="#where-to-put-tests" title="Permalink to this headline">¶</a></h2>
<div class="section" id="package-specific-tests">
<h3>Package-specific tests<a class="headerlink" href="#package-specific-tests" title="Permalink to this headline">¶</a></h3>
<p>Each package should include a suite of unit tests, covering as many of the
public methods/functions as possible. These tests should be included inside
each sub-package, either in a <tt class="xref py py-obj docutils literal"><span class="pre">tests</span></tt> directory, or in a test.py file, e.g:</p>
<div class="highlight-python"><pre>astropy/io/fits/tests/</pre>
</div>
<p>or:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">astropy</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">fits</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">tests</span></tt> directories should contain an <tt class="docutils literal"><span class="pre">__init__.py</span></tt> file so that the tests
can be imported and so that they can use relative imports.</p>
</div>
<div class="section" id="interoperability-tests">
<h3>Interoperability tests<a class="headerlink" href="#interoperability-tests" title="Permalink to this headline">¶</a></h3>
<p>Tests involving two or more sub-packages should be included in:</p>
<div class="highlight-python"><pre>astropy/tests/</pre>
</div>
<p>and using:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">astropy</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<p>then runs both these interoperability tests, and all the unit tests in the
sub-packages. This functionality is especially important for people who install
packages through bundles and package managers, where the original source code
for the tests is not immediately available.</p>
</div>
</div>
<div class="section" id="writing-tests">
<h2>Writing tests<a class="headerlink" href="#writing-tests" title="Permalink to this headline">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">py.test</span></tt> has the following test discovery rules:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">test_*.py</span></tt> or <tt class="docutils literal"><span class="pre">*_test.py</span></tt> files</li>
<li><tt class="docutils literal"><span class="pre">Test</span></tt> prefixed classes (without an <tt class="docutils literal"><span class="pre">__init__</span></tt> method)</li>
<li><tt class="docutils literal"><span class="pre">test_</span></tt> prefixed functions and methods</li>
</ul>
</div></blockquote>
<p>Consult the <a class="reference external" href="http://pytest.org/latest/goodpractises.html#conventions-for-python-test-discovery">test discovery rules</a>
for detailed information on how to name files and tests so that they are
automatically discovered by <tt class="docutils literal"><span class="pre">py.test</span></tt>.</p>
<div class="section" id="simple-example">
<h3>Simple example<a class="headerlink" href="#simple-example" title="Permalink to this headline">¶</a></h3>
<p>The following example shows a simple function and a test to test this
function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_answer</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">func</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
</pre></div>
</div>
<p>If we place this in a <tt class="docutils literal"><span class="pre">test.py</span></tt> file and then run:</p>
<div class="highlight-python"><pre>py.test test.py</pre>
</div>
<p>The result is:</p>
<div class="highlight-python"><pre>============================= test session starts ==============================
python: platform darwin -- Python 2.7.2 -- pytest-1.1.1
test object 1: /Users/tom/tmp/test.py

test.py F

=================================== FAILURES ===================================
_________________________________ test_answer __________________________________

    def test_answer():
&gt;       assert func(3) == 5
E       assert 4 == 5
E        +  where 4 = func(3)

test.py:5: AssertionError
=========================== 1 failed in 0.07 seconds ===========================</pre>
</div>
</div>
<div class="section" id="working-with-data-files">
<h3>Working with data files<a class="headerlink" href="#working-with-data-files" title="Permalink to this headline">¶</a></h3>
<p>Tests that need to make use of a data file should use the
<tt class="xref py py-obj docutils literal"><span class="pre">get_data_fileobj</span></tt> or
<tt class="xref py py-obj docutils literal"><span class="pre">get_data_filename</span></tt> functions.  These functions search
locally first, and then on the astropy data server or an arbitrary URL, and
return a file-like object or a local filename, respectively.  They automatically
cache the data locally if remote data is obtained, and from then on the local
copy will be used transparently.</p>
<p>They also support the use of an MD5 hash to get a specific version of a data
file.  This hash can be obtained prior to submitting a file to the astropy
data server by using the <a class="reference internal" href="../_generated/astropy.utils.data.compute_hash.html#astropy.utils.data.compute_hash" title="astropy.utils.data.compute_hash"><tt class="xref py py-obj docutils literal"><span class="pre">compute_hash</span></tt></a> function on a
local copy of the file.</p>
<p>Tests that may retrieve remote data should be marked with the <tt class="docutils literal"><span class="pre">&#64;remote_data</span></tt>
decorator. Tests marked with this decorator will be skipped by default by
<tt class="docutils literal"><span class="pre">astropy.test()</span></tt> to prevent test runs from taking too long. These tests can
be run by <tt class="docutils literal"><span class="pre">astropy.test()</span></tt> by adding the <tt class="docutils literal"><span class="pre">remote_data=True</span></tt> flag.
Turn on the remote data tests at the command line with
<tt class="docutils literal"><span class="pre">py.test</span> <span class="pre">--remote-data</span></tt>.</p>
<div class="section" id="examples">
<h4>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">...config</span> <span class="kn">import</span> <span class="n">get_data_filename</span>
<span class="kn">from</span> <span class="nn">...tests.helper</span> <span class="kn">import</span> <span class="n">remote_data</span>

<span class="k">def</span> <span class="nf">test_1</span><span class="p">():</span>
    <span class="c">#if filename.fits is a local file in the source distribution</span>
    <span class="n">datafile</span> <span class="o">=</span> <span class="n">get_data_filename</span><span class="p">(</span><span class="s">&#39;filename.fits&#39;</span><span class="p">)</span>
    <span class="c"># do the test</span>

<span class="nd">@remote_data</span>
<span class="k">def</span> <span class="nf">test_2</span><span class="p">():</span>
    <span class="c">#this is the hash for a particular version of a file stored on the</span>
    <span class="c">#astropy data server.</span>
    <span class="n">datafile</span> <span class="o">=</span> <span class="n">get_data_filename</span><span class="p">(</span><span class="s">&#39;hash/94935ac31d585f68041c08f87d1a19d4&#39;</span><span class="p">)</span>
    <span class="c"># do the test</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">get_remote_test_data</span></tt> will place the files in a temporary directory
indicated by the <tt class="docutils literal"><span class="pre">tempfile</span></tt> module, so that the test files will eventually
get removed by the system. In the long term, once test data files become too
large, we will need to design a mechanism for removing test data immediately.</p>
</div>
</div>
<div class="section" id="tests-that-create-files">
<h3>Tests that create files<a class="headerlink" href="#tests-that-create-files" title="Permalink to this headline">¶</a></h3>
<p>Tests may often be run from directories where users do not have write permissions
so tests which create files should always do so in temporary directories. This
can be done with the <a class="reference external" href="http://pytest.org/latest/tmpdir.html">py.test tmpdir function argument</a>
or with Python&#8217;s built-in <a class="reference external" href="http://docs.python.org/library/tempfile.html#module-tempfile">tempfile module</a>.</p>
</div>
<div class="section" id="setting-up-tearing-down-tests">
<h3>Setting up/Tearing down tests<a class="headerlink" href="#setting-up-tearing-down-tests" title="Permalink to this headline">¶</a></h3>
<p>In some cases, it can be useful to run a series of tests requiring something
to be set up first. There are four ways to do this:</p>
<div class="section" id="module-level-setup-teardown">
<h4>Module-level setup/teardown<a class="headerlink" href="#module-level-setup-teardown" title="Permalink to this headline">¶</a></h4>
<p>If the <tt class="docutils literal"><span class="pre">setup_module</span></tt> and <tt class="docutils literal"><span class="pre">teardown_module</span></tt> functions are specified in a
file, they are called before and after all the tests in the file respectively.
These functions take one argument, which is the module itself, which makes it
very easy to set module-wide variables:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setup_module</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="n">module</span><span class="o">.</span><span class="n">NUM</span> <span class="o">=</span> <span class="mi">11</span>

<span class="k">def</span> <span class="nf">add_num</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">NUM</span>

<span class="k">def</span> <span class="nf">test_42</span><span class="p">():</span>
    <span class="n">added</span> <span class="o">=</span> <span class="n">add_num</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">added</span> <span class="o">==</span> <span class="mi">53</span>
</pre></div>
</div>
<p>We can use this for example to download a remote test data file and have all
the functions in the file access it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">setup_module</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="n">module</span><span class="o">.</span><span class="n">DATAFILE</span> <span class="o">=</span> <span class="n">get_remote_test_data</span><span class="p">(</span><span class="s">&#39;94935ac31d585f68041c08f87d1a19d4&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">DATAFILE</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
    <span class="c"># do the test</span>

<span class="k">def</span> <span class="nf">teardown_module</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">DATAFILE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="class-level">
<h4>Class-level<a class="headerlink" href="#class-level" title="Permalink to this headline">¶</a></h4>
<p>Tests can be organized into classes that have their own setup/teardown
functions. In the following</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">add_nums</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="k">class</span> <span class="nc">TestAdd42</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">test_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">add_nums</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">added</span> <span class="o">==</span> <span class="mi">53</span>

    <span class="k">def</span> <span class="nf">test_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">add_nums</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">added</span> <span class="o">==</span> <span class="mi">55</span>

    <span class="k">def</span> <span class="nf">teardown_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>In the above example, the <tt class="docutils literal"><span class="pre">setup_class</span></tt> method is called first, then all the
tests in the class, and finally the <tt class="docutils literal"><span class="pre">teardown_class</span></tt> is called.</p>
</div>
<div class="section" id="method-level">
<h4>Method-level<a class="headerlink" href="#method-level" title="Permalink to this headline">¶</a></h4>
<p>There are cases where one might want setup and teardown methods to be run
before and after <em>each</em> test. For this, use the <tt class="docutils literal"><span class="pre">setup_method</span></tt> and
<tt class="docutils literal"><span class="pre">teardown_method</span></tt> methods:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">add_nums</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="k">class</span> <span class="nc">TestAdd42</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">test_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">add_nums</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">added</span> <span class="o">==</span> <span class="mi">53</span>

    <span class="k">def</span> <span class="nf">test_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">add_nums</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">added</span> <span class="o">==</span> <span class="mi">55</span>

    <span class="k">def</span> <span class="nf">teardown_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="function-level">
<h4>Function-level<a class="headerlink" href="#function-level" title="Permalink to this headline">¶</a></h4>
<p>Finally, one can use <tt class="docutils literal"><span class="pre">setup_function</span></tt> and <tt class="docutils literal"><span class="pre">teardown_function</span></tt> to define a
setup/teardown mechanism to be run before and after each function in a module.
These take one argument, which is the function being tested:</p>
<div class="highlight-python"><pre>def setup_function(function):
    pass

def test_1(self):
    # do test

def test_2(self):
    # do test

def teardown_method(function):
    pass</pre>
</div>
</div>
</div>
<div class="section" id="parametrizing-tests">
<h3>Parametrizing tests<a class="headerlink" href="#parametrizing-tests" title="Permalink to this headline">¶</a></h3>
<p>If you want to run a test several times for slightly different values, then
it can be advantageous to use the <tt class="docutils literal"><span class="pre">py.test</span></tt> option to parametrize tests.
For example, instead of writing:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test1</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span>

<span class="k">def</span> <span class="nf">test2</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span>

<span class="k">def</span> <span class="nf">test3</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span>
</pre></div>
</div>
<p>You can use the <tt class="docutils literal"><span class="pre">parametrize</span></tt> decorator to loop over the different
inputs:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@pytest.mark.parametrize</span><span class="p">((</span><span class="s">&#39;letter&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">letter</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span>
</pre></div>
</div>
</div>
<div class="section" id="using-py-test-helper-functions">
<h3>Using py.test helper functions<a class="headerlink" href="#using-py-test-helper-functions" title="Permalink to this headline">¶</a></h3>
<p>If your tests need to use <a class="reference external" href="http://pytest.org/latest/builtin.html#pytest-helpers">py.test helper functions</a>, such as <tt class="docutils literal"><span class="pre">pytest.raises</span></tt>,
import <tt class="docutils literal"><span class="pre">pytest</span></tt> into your test module like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">...tests.helper</span> <span class="kn">import</span> <span class="n">pytest</span>
</pre></div>
</div>
<p>You may need to adjust the relative import to work for the depth of your module.
<tt class="docutils literal"><span class="pre">tests.helper</span></tt> imports <tt class="docutils literal"><span class="pre">pytest</span></tt> either from the user&#8217;s system or <tt class="docutils literal"><span class="pre">extern.pytest</span></tt>
if the user does not have py.test installed. This is so that users need not
install py.test to run AstroPy&#8217;s tests.</p>
</div>
</div>
<div class="section" id="using-data-in-tests">
<h2>Using data in tests<a class="headerlink" href="#using-data-in-tests" title="Permalink to this headline">¶</a></h2>
<p>Tests can include very small datafiles, but any files significantly larger
than the source code should be placed on a remote server. The base URL for the
test files will be:</p>
<div class="highlight-python"><pre>http://data.astropy.org/</pre>
</div>
<p>and files will be accessed by their MD5 hash, for example:</p>
<div class="highlight-python"><pre>http://data.astropy.org/94935ac31d585f68041c08f87d1a19d4</pre>
</div>
<p>Tests then retrieve data via this URL. This implicitly allows versioning,
since different versions of data files will have different hashes. Old data
files should not be removed, so that tests can be run in any version of
AstroPy.</p>
<p>The details of the server implementation have yet to be decided, but using
these static hash-based URLs ensures that even if we change the backend, the
URL will remain the same.</p>
</div>
<div class="section" id="tests-requiring-optional-dependencies">
<h2>Tests requiring optional dependencies<a class="headerlink" href="#tests-requiring-optional-dependencies" title="Permalink to this headline">¶</a></h2>
<p>For tests that test functions or methods that require optional dependencies (e.g. Scipy), pytest should be instructed to skip the test if the dependencies are not present. The following example shows how this should be done:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pytest</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">scipy</span>
    <span class="n">HAS_SCIPY</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_SCIPY</span> <span class="o">=</span> <span class="bp">False</span>

<span class="nd">@pytest.mark.skipif</span><span class="p">(</span><span class="s">&#39;not HAS_SCIPY&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_that_uses_scipy</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>In this way, the test is run if Scipy is present, and skipped if not. No tests should fail simply because an optional dependency is not present.</p>
</div>
<div class="section" id="test-coverage-reports">
<h2>Test coverage reports<a class="headerlink" href="#test-coverage-reports" title="Permalink to this headline">¶</a></h2>
<p>Astropy can use <a class="reference external" href="http://nedbatchelder.com/code/coverage/">coverage.py</a> to generate test coverage
reports.  To generate a test coverage report, use:</p>
<div class="highlight-python"><pre>python setup.py test --coverage</pre>
</div>
<p>There is a <a class="reference external" href="http://nedbatchelder.com/code/coverage/config.html">coveragerc</a> file that
defines files to omit as well as lines to exclude.  It is installed
along with astropy so that the <tt class="xref py py-obj docutils literal"><span class="pre">astropy.test</span></tt> function can use it.  In
the source tree, it is at <tt class="xref py py-obj docutils literal"><span class="pre">astropy/tests/coveragerc</span></tt>.</p>
<div class="section" id="marking-blocks-of-code-to-exclude-from-coverage">
<h3>Marking blocks of code to exclude from coverage<a class="headerlink" href="#marking-blocks-of-code-to-exclude-from-coverage" title="Permalink to this headline">¶</a></h3>
<p>Blocks of code may be ignored by adding a comment containing the
phrase <tt class="docutils literal"><span class="pre">pragma:</span> <span class="pre">no</span> <span class="pre">cover</span></tt> to the start of the block:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">this_rarely_happens</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
    <span class="n">this_call_is_ignored</span><span class="p">()</span>
</pre></div>
</div>
<p>Blocks of code that are intended to run only in Python 2.x or 3.x may
also be marked so that they will be ignored when appropriate by
<tt class="xref py py-obj docutils literal"><span class="pre">coverage.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c"># pragma: py3</span>
    <span class="n">do_it_the_python3_way</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>  <span class="c"># pragma: py2</span>
    <span class="n">do_it_the_python2_way</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">


<h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Testing Guidelines</a><ul>
<li><a class="reference internal" href="#testing-framework">Testing Framework</a></li>
<li><a class="reference internal" href="#running-tests">Running Tests</a><ul>
<li><a class="reference internal" href="#setup-py-test">setup.py test</a></li>
<li><a class="reference internal" href="#id3">py.test</a></li>
<li><a class="reference internal" href="#astropy-test">astropy.test()</a></li>
</ul>
</li>
<li><a class="reference internal" href="#regression-tests">Regression tests</a></li>
<li><a class="reference internal" href="#where-to-put-tests">Where to put tests</a><ul>
<li><a class="reference internal" href="#package-specific-tests">Package-specific tests</a></li>
<li><a class="reference internal" href="#interoperability-tests">Interoperability tests</a></li>
</ul>
</li>
<li><a class="reference internal" href="#writing-tests">Writing tests</a><ul>
<li><a class="reference internal" href="#simple-example">Simple example</a></li>
<li><a class="reference internal" href="#working-with-data-files">Working with data files</a><ul>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tests-that-create-files">Tests that create files</a></li>
<li><a class="reference internal" href="#setting-up-tearing-down-tests">Setting up/Tearing down tests</a><ul>
<li><a class="reference internal" href="#module-level-setup-teardown">Module-level setup/teardown</a></li>
<li><a class="reference internal" href="#class-level">Class-level</a></li>
<li><a class="reference internal" href="#method-level">Method-level</a></li>
<li><a class="reference internal" href="#function-level">Function-level</a></li>
</ul>
</li>
<li><a class="reference internal" href="#parametrizing-tests">Parametrizing tests</a></li>
<li><a class="reference internal" href="#using-py-test-helper-functions">Using py.test helper functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-data-in-tests">Using data in tests</a></li>
<li><a class="reference internal" href="#tests-requiring-optional-dependencies">Tests requiring optional dependencies</a></li>
<li><a class="reference internal" href="#test-coverage-reports">Test coverage reports</a><ul>
<li><a class="reference internal" href="#marking-blocks-of-code-to-exclude-from-coverage">Marking blocks of code to exclude from coverage</a></li>
</ul>
</li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>

<footer class="footer">
  <p class="pull-right">
    <a href="http://github.com/astropy/astropy/tree/v0.2.1/docs/development/testguide.rst">Edit This Page on Github</a> &nbsp;
    <a href="../_sources/development/testguide.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2011-2013, The Astropy Developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3+. &nbsp;
    Last built 03 Apr 2013. <br/>
  </p>
</footer>
 <!-- End original user content -->


<br>
<br>
<br>


<style type="text/css">
  .rtd-badge {
    position: fixed;
    display: block;
    bottom: 5px;
    height: 40px;
    text-indent: -9999em;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
    -moz-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
    -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
  }
  #version_menu {
    position: fixed;
    display: none;
    bottom: 11px;
    right: 166px;
    list-style-type: none;
    margin: 0;
  }
  .footer_popout:hover #version_menu {
    display: block;
  }
  #version_menu li {
    display: block;
    float: right;
  }
  #version_menu li a {
    display: block;
    padding: 6px 10px 4px 10px;
    margin: 7px 7px 0 0;
    font-weight: bold;
    font-size: 14px;
    height: 20px;
    line-height: 17px;
    text-decoration: none;
    color: #fff;
    background: #8ca1af url(../images/gradient-light.png) bottom left repeat-x;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    box-shadow: 0 1px 1px #465158;
    -moz-box-shadow: 0 1px 1px #465158;
    -webkit-box-shadow: 0 1px 1px #465158;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
  }
  #version_menu li a:hover {
    text-decoration: none;
    background-color: #697983;
    box-shadow: 0 1px 0px #465158;
    -moz-box-shadow: 0 1px 0px #465158;
    -webkit-box-shadow: 0 1px 0px #465158;
  }
  .rtd-badge.rtd {
    background: #3b4449 url(//media.readthedocs.org//images/badge-rtd.png) scroll 0px -46px no-repeat;
    border: 1px solid #282E32;
    width: 41px;
    right: 5px;
  }
  .footer_popout:hover .rtd-badge.rtd {
    background-position: top left;
    width: 160px;
  }
  .rtd-badge.revsys { background: #465158 url(//media.readthedocs.org//images/badge-revsys.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 290px;
    right: 173px;
  }
  .rtd-badge.revsys-inline-sponsored {
    position: inherit;
    margin-left: auto;
    margin-right: 175px;
    margin-bottom: 5px;
    background: #465158 url(//media.readthedocs.org//images/badge-revsys.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 290px;
    right: 173px;
  }
  .rtd-badge.revsys-inline {
    position: inherit;
    margin-left: auto;
    margin-right: 175px;
    margin-bottom: 5px;
    background: #465158 url(//media.readthedocs.org//images/badge-revsys-sm.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 205px;
    right: 173px;
  }

</style>
<div class="rtd_doc_footer">
  <div class="footer_popout">
    <a href="//readthedocs.org/projects/astropy/?fromdocs=astropy" class="rtd-badge rtd"> Brought to you by Read the Docs</a>
    <ul id="version_menu">
      
        <li><a href="/en/latest/">latest</a></li>
      
        <li><a href="/en/add-mpl-to-rtd-pip-req/">add-mpl-to-rtd-pip-req</a></li>
      
        <li><a href="/en/v0.2.1/">v0.2.1</a></li>
      
        <li><a href="/en/v0.2/">v0.2</a></li>
      
        <li><a href="/en/v0.1/">v0.1</a></li>
      
    </ul>
  </div>
</div>
<!-- RTD Analytics Code -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17997319-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


<!-- User Analytics Code -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30968842-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



  </body>
</html>