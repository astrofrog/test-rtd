
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    

    <title>Building, Cython/C Extensions, and Releasing &mdash; Astropy v0.2.1</title>
<!-- RTD <head> -->
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript" src="//media.readthedocs.org/javascript/underscore.js"></script>
<script type="text/javascript" src="//media.readthedocs.org/javascript/doctools.js"></script>

<script type="text/javascript">
  // This is included here for Javascript that doesn't have access to the templates.
  var doc_version = "v0.2.1";
  var doc_slug = "astropy";
</script>

<script type="text/javascript" src="//media.readthedocs.org/javascript/rtd.js"></script>
<!-- end RTD <head> -->

    
    <link rel="stylesheet" href="../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../_static/astropy_logo.ico"/>
    <link rel="top" title="Astropy v0.2.1" href="../index.html" />
    <link rel="next" title="Writing Command-Line Scripts" href="scripts.html" />
    <link rel="prev" title="Testing Guidelines" href="testguide.html" /> 
  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"></a>
  <ul>
    <li><a class="homelink" title="AstroPy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../genindex.html">Index</a></li>
    <li><a title="Python Module Index" href="../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="scripts.html" title="Writing Command-Line Scripts">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="testguide.html" title="Testing Guidelines">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../index.html">Astropy v0.2.1</a>
	 &raquo;
      </li>
      
      <li>Building, Cython/C Extensions, and Releasing</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="building-cython-c-extensions-and-releasing">
<h1>Building, Cython/C Extensions, and Releasing<a class="headerlink" href="#building-cython-c-extensions-and-releasing" title="Permalink to this headline">¶</a></h1>
<p>The build process currently uses the
<a class="reference external" href="http://packages.python.org/distribute/">Distribute</a> package to build and
install the astropy core (and any affiliated packages that use the template).
The user doesn&#8217;t necessarily need to have <tt class="xref py py-obj docutils literal"><span class="pre">distribute</span></tt> installed, as it will
automatically bootstrap itself using the <tt class="docutils literal"><span class="pre">distribute_setup.py</span></tt> file in the
source distribution if it isn&#8217;t installed for the user.</p>
<div class="section" id="customizing-setup-build-for-subpackages">
<h2>Customizing setup/build for subpackages<a class="headerlink" href="#customizing-setup-build-for-subpackages" title="Permalink to this headline">¶</a></h2>
<p>As is typical, there is a single <tt class="docutils literal"><span class="pre">setup.py</span></tt> file that is used for the whole
<tt class="xref py py-obj docutils literal"><span class="pre">astropy</span></tt> package.  To customize setup parameters for a given sub-package, a
<tt class="docutils literal"><span class="pre">setup_package.py</span></tt> file can be defined inside a package, and if it is present,
the setup process will look for the following functions to customize the build
process:</p>
<ul>
<li><dl class="first docutils">
<dt><tt class="xref py py-func docutils literal"><span class="pre">get_package_data()</span></tt></dt>
<dd><p class="first">This function, if defined, should return a dictionary mapping the name of
the subpackage(s) that need package data to a list of data file paths
(possibly including wildcards) relative to the path of the package&#8217;s source
code.  e.g. if the source distribution has a needed data file
<tt class="docutils literal"><span class="pre">astropy/wcs/tests/data/3d_cd.hdr</span></tt>, this function should return
<tt class="docutils literal"><span class="pre">{'astropy.wcs.tests:'['data/3d_cd.hdr']}</span></tt>. See the <tt class="docutils literal"><span class="pre">package_data</span></tt>
option of the  <a class="reference external" href="http://docs.python.org/distutils/apiref.html#distutils.core.setup" title="(in Python v2.7)"><tt class="xref py py-func docutils literal"><span class="pre">distutils.core.setup()</span></tt></a> function.</p>
<p class="last">It is recommended that all such data be in a directory named &#8220;data&#8221; inside
the package within which it is supposed to be used, and package data should
be accessed via the <tt class="xref py py-obj docutils literal"><span class="pre">astropy.utils.data.get_data_filename</span></tt> and
<tt class="xref py py-obj docutils literal"><span class="pre">astropy.utils.data.get_data_fileobj</span></tt> functions.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="xref py py-func docutils literal"><span class="pre">get_extensions()</span></tt></dt>
<dd><p class="first last">This provides information for building C or Cython extensions. If defined,
it should return a list of <a class="reference external" href="http://docs.python.org/distutils/apiref.html#distutils.core.Extension" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">distutils.core.Extension</span></tt></a> objects controlling
the Cython/C build process (see below for more detail).</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="xref py py-func docutils literal"><span class="pre">get_legacy_alias()</span></tt></dt>
<dd><p class="first last">This function allows for the creation of <tt class="xref py py-obj docutils literal"><span class="pre">shims</span></tt> that allow a
subpackage to be imported under another name.  For example,
<tt class="xref py py-obj docutils literal"><span class="pre">astropy.io.fits</span></tt> used to be available under the namespace
<tt class="xref py py-obj docutils literal"><span class="pre">pyfits</span></tt>.  For backward compatibility, it is helpful to have it
still importable under the old name.  Under most circumstances,
this function should call <tt class="xref py py-obj docutils literal"><span class="pre">astropy.setup_helpers.add_legacy_alias</span></tt>
to generate a legacy module and then return what it returns.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="xref py py-func docutils literal"><span class="pre">get_build_options()</span></tt></dt>
<dd><p class="first">This function allows a package to add extra build options.  It
should return a list of tuples, where each element has:</p>
<ul class="simple">
<li><em>name</em>: The name of the option as it would appear on the
commandline or in the <tt class="xref py py-obj docutils literal"><span class="pre">setup.cfg</span></tt> file.</li>
<li><em>doc</em>: A short doc string for the option, displayed by
<tt class="xref py py-obj docutils literal"><span class="pre">setup.py</span> <span class="pre">build</span> <span class="pre">--help</span></tt>.</li>
<li><em>is_bool</em> (optional): When <a class="reference external" href="http://docs.python.org/library/constants.html#True" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">True</span></tt></a>, the option is a boolean
option and doesn&#8217;t have an associated value.</li>
</ul>
<p class="last">Once an option has been added, its value can be looked up using
<tt class="xref py py-obj docutils literal"><span class="pre">astropy.setup_helpers.get_distutils_build_option</span></tt>.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="xref py py-func docutils literal"><span class="pre">get_external_libraries()</span></tt></dt>
<dd><p class="first last">This function declares that the package uses libraries that are
included in the astropy distribution that may also be distributed
elsewhere on the users system.  It should return a list of library
names.  For each library, a new build option is created,
<tt class="xref py py-obj docutils literal"><span class="pre">--use-system-X</span></tt> which allows the user to request to use the
system&#8217;s copy of the library.  The package would typically call
<tt class="xref py py-obj docutils literal"><span class="pre">astropy.setup_helpers.use_system_library</span></tt> from its
<tt class="xref py py-obj docutils literal"><span class="pre">get_extensions</span></tt> function to determine if the package should use
the system library or the included one.</p>
</dd>
</dl>
</li>
</ul>
<p>The <tt class="xref py py-obj docutils literal"><span class="pre">astropy.setup_helpers</span></tt> modules includes a <tt class="xref py py-func docutils literal"><span class="pre">update_package_files()</span></tt>
function which automatically searches the given source path for
<tt class="docutils literal"><span class="pre">setup_package.py</span></tt> modules and calls each of the above functions, if they
exist.  This makes it easy for affiliated packages to use this machinery in
their own <tt class="docutils literal"><span class="pre">setup.py</span></tt>.</p>
</div>
<div class="section" id="c-or-cython-extensions">
<span id="building-c-or-cython-extensions"></span><h2>C or Cython Extensions<a class="headerlink" href="#c-or-cython-extensions" title="Permalink to this headline">¶</a></h2>
<p>Astropy supports using C extensions for wrapping C libraries and Cython for
speeding up computationally-intensive calculations. Both Cython and C extension
building can be customized using the <tt class="xref py py-func docutils literal"><span class="pre">get_extensions()</span></tt> function of the
<tt class="docutils literal"><span class="pre">setup_package.py</span></tt> file. If defined, this function must return a list of
<a class="reference external" href="http://docs.python.org/distutils/apiref.html#distutils.core.Extension" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">distutils.core.Extension</span></tt></a> objects. The creation process is left to the
subpackage designer, and can be customized however is relevant for the
extensions in the subpackage.</p>
<p>While C extensions must always be defined through the <tt class="xref py py-func docutils literal"><span class="pre">get_extensions()</span></tt>
mechanism, Cython files (ending in <tt class="docutils literal"><span class="pre">.pyx</span></tt>) are automatically located and
loaded in separate extensions if they are not in <tt class="xref py py-func docutils literal"><span class="pre">get_extensions()</span></tt>. For
Cython extensions located in this way, headers for numpy C functions are
included in the build, but no other external headers are included. <tt class="docutils literal"><span class="pre">.pyx</span></tt>
files present in the extensions returned by <tt class="xref py py-func docutils literal"><span class="pre">get_extensions()</span></tt> are not
included in the list of extensions automatically generated extensions. Note
that this allows disabling a Cython file by providing an extension that
includes the Cython file, but giving it the special <tt class="xref py py-obj docutils literal"><span class="pre">name</span></tt> &#8216;cython_skip&#8217;. Any
extension with this package name will not be built by <tt class="docutils literal"><span class="pre">setup.py</span></tt>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If an <a class="reference external" href="http://docs.python.org/distutils/apiref.html#distutils.core.Extension" title="(in Python v2.7)"><tt class="xref py py-class docutils literal"><span class="pre">Extension</span></tt></a> object is provided for Cython
source files using the <tt class="xref py py-func docutils literal"><span class="pre">get_extensions()</span></tt> mechanism, it is very
important that the <tt class="docutils literal"><span class="pre">.pyx</span></tt> files be given as the <tt class="xref py py-obj docutils literal"><span class="pre">source</span></tt>, rather than the
<tt class="docutils literal"><span class="pre">.c</span></tt> files generated by Cython.</p>
</div>
<div class="section" id="installing-c-header-files">
<h3>Installing C header files<a class="headerlink" href="#installing-c-header-files" title="Permalink to this headline">¶</a></h3>
<p>If your C extension needs to be linked from other third-party C code,
you probably want to install its header files along side the Python module.</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Create an <tt class="xref py py-obj docutils literal"><span class="pre">include</span></tt> directory inside of your package for
all of the header files.</p>
</li>
<li><p class="first">Use the <tt class="xref py py-func docutils literal"><span class="pre">get_package_data()</span></tt> hook in <tt class="xref py py-obj docutils literal"><span class="pre">setup_package.py</span></tt> to
install those header files.  For example, the <a class="reference internal" href="../wcs/index.html#module-astropy.wcs" title="astropy.wcs"><tt class="xref py py-obj docutils literal"><span class="pre">astropy.wcs</span></tt></a>
package has this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_package_data</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;astropy.wcs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;include/*.h&#39;</span><span class="p">]}</span>
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="preventing-importing-at-build-time">
<h2>Preventing importing at build time<a class="headerlink" href="#preventing-importing-at-build-time" title="Permalink to this headline">¶</a></h2>
<p>In rare cases, some packages may need to be imported at build time.
Unfortunately, anything that requires a C or Cython extension or
processing through 2to3 will fail to import until the build phase has
completed.  In those cases, the <tt class="xref py py-obj docutils literal"><span class="pre">_ASTROPY_SETUP_</span></tt> variable can be used
to determine if the package is being imported as part of the build and
choose to not import problematic modules.  <tt class="xref py py-obj docutils literal"><span class="pre">_ASTROPY_SETUP_</span></tt> is
inserted into the builtins, and is <a class="reference external" href="http://docs.python.org/library/constants.html#True" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">True</span></tt></a> when inside of astropy&#8217;s
<tt class="xref py py-obj docutils literal"><span class="pre">setup.py</span></tt> script, and <a class="reference external" href="http://docs.python.org/library/constants.html#False" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">False</span></tt></a> otherwise.</p>
<p>For example, suppose there is a subpackage <tt class="docutils literal"><span class="pre">foo</span></tt> that needs to
import a module called <tt class="docutils literal"><span class="pre">version.py</span></tt> at build time in order to set
some version information, and also has a C extension, <tt class="docutils literal"><span class="pre">process</span></tt>,
that will not be available in the source tree.  In this case,
<tt class="docutils literal"><span class="pre">astropy/foo/__init__.py</span></tt> would probably want to check the value of
<tt class="xref py py-obj docutils literal"><span class="pre">_ASTROPY_SETUP_</span></tt> before importing the C extension:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="ow">not</span> <span class="n">_ASTROPY_SETUP_</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">process</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">version</span>
</pre></div>
</div>
</div>
<div class="section" id="release">
<h2>Release<a class="headerlink" href="#release" title="Permalink to this headline">¶</a></h2>
<p>The current release procedure for Astropy involves a combination of an
automated release script and some manual steps.  Future versions will automate
more of the process, if not all.</p>
<p>One of the main steps in performing a release is to create a tag in the git
repository representing the exact state of the repository that represents the
version being released.  For Astropy we will always use <a class="reference external" href="http://git-scm.com/book/en/Git-Basics-Tagging#Signed-Tags">signed tags</a>: A
signed tag is annotated with the name and e-mail address of the signer, a date
and time, and a checksum of the code in the tag.  This information is then
signed with a GPG private key and stored in the repository.</p>
<p>Using a signed tag ensures the integrity of the contents of that tag for the
future.  On a distributed VCS like git, anyone can create a tag of Astropy
called &#8220;0.1&#8221; in their repository&#8211;and where it&#8217;s easy to monkey around even
after the tag has been created.  But only one &#8220;0.1&#8221; will be signed by one of
the Astropy project coordinators and will be verifiable with their public key.</p>
<div class="section" id="creating-a-gpg-signing-key-and-a-signed-tag">
<h3>Creating a GPG Signing Key and a Signed Tag<a class="headerlink" href="#creating-a-gpg-signing-key-and-a-signed-tag" title="Permalink to this headline">¶</a></h3>
<p>Git uses GPG to created signed tags, so in order to perform an Astropy release
you will need GPG installed and will have to generated a signing key pair.
Most *NIX installations come with GPG installed by default (as it is used to
verify the integrity of system packages).  If you don&#8217;t have the <tt class="docutils literal"><span class="pre">gpg</span></tt>
command, consult the documentation for your system on how to install it.</p>
<p>For OSX, GPG can be installed from MacPorts using <tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">port</span> <span class="pre">install</span> <span class="pre">gnupg</span></tt>.</p>
<p>To create a new public/private key pair, simply run:</p>
<div class="highlight-python"><pre>$ gpg --gen-key</pre>
</div>
<p>This will take you through a few interactive steps. For the encryption
and expiry settings, it should be safe to use the default settings (I use
a key size of 4096 just because what does a couple extra kilobytes
hurt?) Enter your full name, preferably including your middle name or
middle initial, and an e-mail address that you expect to be active for a
decent amount of time. Note that this name and e-mail address must match
the info you provide as your git configuration, so you should either
choose the same name/e-mail address when you create your key, or update
your git configuration to match the key info. Finally, choose a very good
pass phrase that won&#8217;t be easily subject to brute force attacks.</p>
<p>If you expect to use the same key for some time, it&#8217;s good to make a backup of
both your public and private key:</p>
<div class="highlight-python"><pre>$ gpg --export --armor &gt; public.key
$ gpg --export-secret-key --armor &gt; private.key</pre>
</div>
<p>Back up these files to a trusted location&#8211;preferably a write-once physical
medium that can be stored safely somewhere.  One may also back up their keys to
a trusted online encrypted storage, though some might not find that secure
enough&#8211;it&#8217;s up to you and what you&#8217;re comfortable with.</p>
<div class="section" id="add-your-public-key-to-a-keyserver">
<h4>Add your public key to a keyserver<a class="headerlink" href="#add-your-public-key-to-a-keyserver" title="Permalink to this headline">¶</a></h4>
<p>Now that you have a public key, you can publish this anywhere you like&#8211;in your
e-mail, in a public code repository, etc.  You can also upload it to a
dedicated public OpenPGP keyserver.  This will store the public key
indefinitely (until you manually revoke it), and will be automatically synced
with other keyservers around the world.  That makes it easy to retrieve your
public key using the gpg command-line tool.</p>
<p>To do this you will need your public key&#8217;s keyname.  To find this enter:</p>
<div class="highlight-python"><pre>$ gpg --list-keys</pre>
</div>
<p>This will output something like:</p>
<div class="highlight-python"><pre>/path/to/.gnupg/pubring.gpg
---------------------------------------------
pub   4096D/1234ABCD 2012-01-01
uid                  Your Name &lt;your_email&gt;
sub   4096g/567890EF 2012-01-01</pre>
</div>
<p>The 8 digit hex number on the line starting with &#8220;pub&#8221;&#8211;in this example the
&#8220;1234ABCD&#8221; unique keyname for your public key.  To push it to a keyserver
enter:</p>
<div class="highlight-python"><pre>$ gpg --send-keys 1234ABCD</pre>
</div>
<p>But replace the 1234ABCD with the keyname for your public key.  Most systems
come configured with a sensible default keyserver, so you shouldn&#8217;t have to
specify any more than that.</p>
</div>
<div class="section" id="create-a-tag">
<h4>Create a tag<a class="headerlink" href="#create-a-tag" title="Permalink to this headline">¶</a></h4>
<p>Now test creating a signed tag in git.  It&#8217;s safe to experiment with this&#8211;you
can always delete the tag before pushing it to a remote repository:</p>
<div class="highlight-python"><pre>$ git tag -s v0.1 -m "Astropy version 0.1"</pre>
</div>
<p>This will ask for the password to unlock your private key in order to sign
the tag with it.  Confirm that the default signing key selected by git is the
correct one (it will be if you only have one key).</p>
<p>Once the tag has been created, you can verify it with:</p>
<div class="highlight-python"><pre>$ git tag -v v0.1</pre>
</div>
<p>This should output something like:</p>
<div class="highlight-python"><pre>object e8e3e3edc82b02f2088f4e974dbd2fe820c0d934
type commit
tag v0.1
tagger Your Name &lt;your_email&gt; 1339779534 -0400

Astropy version 0.1
gpg: Signature made Fri 15 Jun 2012 12:59:04 PM EDT using DSA key ID 0123ABCD
gpg: Good signature from "Your Name &lt;your_email&gt;"</pre>
</div>
<p>You can use this to verify signed tags from any repository as long as you have
the signer&#8217;s public key in your keyring.  In this case you signed the tag
yourself, so you already have your public key.</p>
<p>Note that if you are planning to do a release following the steps below, you
will want to delete the tag you just created, because the release script does
that for you.  You can delete this tag by doing:</p>
<div class="highlight-python"><pre>$ git tag -d v0.1</pre>
</div>
</div>
</div>
<div class="section" id="release-procedure">
<h3>Release Procedure<a class="headerlink" href="#release-procedure" title="Permalink to this headline">¶</a></h3>
<p>The automated portion of the Astropy release procedure uses <a class="reference external" href="http://pypi.python.org/pypi/zest.releaser">zest.releaser</a>
to create the tag and update the version.  zest.releaser is extendable through
hook functions&#8211;Astropy already includes a couple hook functions to modify the
default behavior, but future releases may be further automated through the
implementation of additional hook functions.  In order to use the hooks,
Astropy itself must be <em>installed</em> alongside zest.releaser.  It is recommended
to create a <a class="reference external" href="http://pypi.python.org/pypi/virtualenv">virtualenv</a> specifically for this purpose.</p>
<p>This may seem like a lot of steps, but most of them won&#8217;t be necessary to
repeat for each release.  The advantage of using an automated or semi-automated
procedure is that ensures a consistent release process each time.</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Update the list of contributors in the <tt class="docutils literal"><span class="pre">creditsandlicense.rst</span></tt> file. The
easiest way to check this is do:</p>
<div class="highlight-python"><pre>$ git shortlog -s</pre>
</div>
<p>And just add anyone from that list who isn&#8217;t already credited.</p>
</li>
<li><p class="first">Install virtualenv if you don&#8217;t already have it.  See the linked virtualenv
documentation for details.  Also, make sure that you have <a class="reference external" href="http://www.cython.org/">cython</a>
installed, as you will need it to generate the .c files needed for the
release.</p>
</li>
<li><p class="first">Create and activate a virtualenv:</p>
<div class="highlight-python"><pre>$ virtualenv --system-site-packages --distribute astropy-release
$ source astropy-release/bin/activate</pre>
</div>
</li>
<li><p class="first">Obtain a <em>clean</em> version of the Astropy repository.  That is, one
where you don&#8217;t have any intermediate build files.  Either use a fresh
<tt class="docutils literal"><span class="pre">git</span> <span class="pre">clone</span></tt> or do <tt class="docutils literal"><span class="pre">git</span> <span class="pre">clean</span> <span class="pre">-dfx</span></tt>.</p>
</li>
<li><p class="first">Be sure you&#8217;re the &#8220;master&#8221; branch, and install Astropy into the
virtualenv:</p>
<div class="highlight-python"><pre>$ python setup.py install</pre>
</div>
<p>This is necessary for two reasons.  First, the entry points for the
releaser scripts need to be availale, and these are in the Astropy
package. Second, the build process will generate .c files from the
Cython .pyx files, and the .c files are necessary for the source
distribution.</p>
</li>
<li><p class="first">Install zest.releaser into the virtualenv; use <tt class="docutils literal"><span class="pre">--upgrade</span> <span class="pre">--force</span></tt> to
ensure that the latest version is installed in the virtualenv (if you&#8217;re
running a csh variant make sure to run <tt class="docutils literal"><span class="pre">rehash</span></tt> afterwards too):</p>
<div class="highlight-python"><pre>$ pip install zest.releaser --upgrade --force</pre>
</div>
</li>
<li><p class="first">Ensure that all changes to the code have been committed, then start the
release by running:</p>
<div class="highlight-python"><pre>$ fullrelease</pre>
</div>
</li>
<li><p class="first">You will be asked to enter the version to be released.  Press enter to
accept the default (which will normally be correct) or enter a specific
version string.  A diff will then be shown of CHANGES.rst and setup.py
showing that a release date has been added to the changelog, and that the
version has been updated in setup.py.  Enter &#8216;Y&#8217; when asked to commit
these changes.</p>
</li>
<li><p class="first">You will then be shown the command that will be run to tag the release.
Enter &#8216;Y&#8217; to confirm and run the command.</p>
</li>
<li><p class="first">When asked &#8220;Check out the tag (for tweaks or pypi/distutils server
upload)&#8221; enter &#8216;N&#8217;: zest.releaser does not offer enough control yet over
how the register and upload are performed so we will do this manually
until the release scripts have been improved.</p>
</li>
<li><p class="first">You will be asked to enter a new development version.  Normally the next
logical version will be selected&#8211;press enter to accept the default, or
enter a specific version string.  Do not add &#8221;.dev&#8221; to the version, as
this will be appended automatically (ignore the message that says &#8221;.dev0
will be appended&#8221;&#8211;it will actually be &#8221;.dev&#8221; without the 0).  For
example, if the just-released version was &#8220;0.1&#8221; the default next version
will be &#8220;0.2&#8221;.  If we want the next version to be, say &#8220;1.0&#8221; then that
must be entered manually.</p>
</li>
<li><p class="first">You will be shown a diff of CHANGES.rst showing that a new section has
been added for the new development version, and showing that the version
has been updated in setup.py.  Enter &#8216;Y&#8217; to commit these changes.</p>
</li>
<li><p class="first">When asked to push the changes to a remote repository, enter &#8216;Y&#8217;.  This
should complete the portion of the process that&#8217;s automated at this point.</p>
</li>
<li><p class="first">Check out the tag of the released version.  For example:</p>
<div class="highlight-python"><pre>$ git checkout v0.1</pre>
</div>
</li>
<li><p class="first">Create the source distribution by doing:</p>
<div class="highlight-python"><pre>$ python setup.py sdist</pre>
</div>
<p>Copy the produced <tt class="docutils literal"><span class="pre">.tar.gz</span></tt> somewhere and verify that you can unpack it,
build it, and get all the tests to pass.  It would be best to create a new
virtualenv in which to do this.</p>
</li>
<li><p class="first">Register the release on PyPI with:</p>
<div class="highlight-python"><pre>$ python setup.py register</pre>
</div>
</li>
<li><p class="first">Upload the source distribution to PyPI; this is preceded by re-running
the sdist command, which is necessary for the upload command to know
which distribution to upload:</p>
<div class="highlight-python"><pre>$ python setup.py sdist upload</pre>
</div>
</li>
<li><p class="first">Update the website to reflect the fact there is now a stable release.</p>
</li>
<li><p class="first">Update Readthedocs so that it builds docs for the corresponding github tag,
and set the default page to the new release.</p>
</li>
<li><p class="first">Create a bug fix branch.  If the version just was released was a &#8220;X.Y.0&#8221;
version (&#8220;0.1&#8221; or &#8220;0.2&#8221; for example&#8211;the final &#8221;.0&#8221; is typically ommitted)
it is good to create a bug fix branch as well.  Starting from the tagged
changset, just checkout a new branch and push it to the remote server.
For example, after releasing version 0.1, do:</p>
<div class="highlight-python"><pre>$ git checkout -b v0.1.x</pre>
</div>
<p>Then edit <tt class="docutils literal"><span class="pre">setup.py</span></tt> so that the version is <tt class="docutils literal"><span class="pre">'0.1.1.dev'</span></tt>, and commit
that change. Then, do:</p>
<div class="highlight-python"><pre>$ git push upstream v0.1.x</pre>
</div>
</li>
</ol>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<blockquote>
<div>You may need to replace <tt class="docutils literal"><span class="pre">upstream</span></tt> here with <tt class="docutils literal"><span class="pre">astropy</span></tt> or
whatever remote name you use for the main astropy repository.</div></blockquote>
<p class="last">The purpose of this branch is for creating bug fix releases like &#8220;0.1.1&#8221;
and &#8220;0.1.2&#8221;, while allowing development of new features to continue in
the master branch.  Only changesets that fix bugs without making
significant API changes should be merged to the bug fix branches.</p>
</div>
</div></blockquote>
<ol class="arabic simple" start="21">
<li>Create a bug fix label on GitHub; this should have the same name as the
just created bug fix branch.  This label should be applied to all issues
that should be backported to the bug fix branch.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="creating-a-macos-x-installer-on-a-dmg">
<h3>Creating a MacOS X Installer on a DMG<a class="headerlink" href="#creating-a-macos-x-installer-on-a-dmg" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">bdist_dmg</span></tt> command can be used to create a <tt class="docutils literal"><span class="pre">.dmg</span></tt> disk image for
MacOS X with a <tt class="docutils literal"><span class="pre">.pkg</span></tt> installer. In order to do this, you will need to
ensure that you have the following dependencies installed:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.numpy.org">Numpy</a></li>
<li><a class="reference external" href="http://sphinx.pocoo.org">Sphinx</a></li>
<li><a class="reference external" href="http://pypi.python.org/pypi/bdist_mpkg/">bdist_mpkg</a></li>
</ul>
<p>To create a <tt class="docutils literal"><span class="pre">.dmg</span></tt> file, run:</p>
<div class="highlight-python"><pre>python setup.py bdist_dmg</pre>
</div>
<p>Note that for the actual release version, you should do this with the Python
distribution from <a class="reference external" href="http://python.org">python.org</a> (not e.g. MacPorts, EPD,
etc.). The best way to ensure maximum compatibility is to make sure that
Python and Numpy are installed into <tt class="docutils literal"><span class="pre">/Library/Frameworks/Python.framework</span></tt>
using the latest stable <tt class="docutils literal"><span class="pre">.dmg</span></tt> installers available for those packages. In
addition, the <tt class="docutils literal"><span class="pre">.dmg</span></tt> should be build on a MacOS 10.6 system, to ensure
compatibility with 10.6, 10.7, and 10.8.</p>
<p>Before distributing, you should test out an installation of Python, Numpy, and
Astropy from scratch using the <tt class="docutils literal"><span class="pre">.dmg</span></tt> installers, preferably on a clean
virtual machine.</p>
</div>
</div>
<div class="section" id="future-directions">
<h2>Future directions<a class="headerlink" href="#future-directions" title="Permalink to this headline">¶</a></h2>
<p>We plan to switch to a newer packaging scheme when it&#8217;s more stable, the
upcoming standard library <tt class="xref py py-obj docutils literal"><span class="pre">packaging</span></tt> module, derived from the
<a class="reference external" href="http://packages.python.org/Distutils2/library/distutils2.html">distutils2</a>
project.  Until it&#8217;s working right, however, we will be using <tt class="xref py py-obj docutils literal"><span class="pre">distribute</span></tt> and
<a class="reference external" href="http://docs.python.org/library/distutils.html#distutils" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">distutils</span></tt></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">


<h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Building, Cython/C Extensions, and Releasing</a><ul>
<li><a class="reference internal" href="#customizing-setup-build-for-subpackages">Customizing setup/build for subpackages</a></li>
<li><a class="reference internal" href="#c-or-cython-extensions">C or Cython Extensions</a><ul>
<li><a class="reference internal" href="#installing-c-header-files">Installing C header files</a></li>
</ul>
</li>
<li><a class="reference internal" href="#preventing-importing-at-build-time">Preventing importing at build time</a></li>
<li><a class="reference internal" href="#release">Release</a><ul>
<li><a class="reference internal" href="#creating-a-gpg-signing-key-and-a-signed-tag">Creating a GPG Signing Key and a Signed Tag</a><ul>
<li><a class="reference internal" href="#add-your-public-key-to-a-keyserver">Add your public key to a keyserver</a></li>
<li><a class="reference internal" href="#create-a-tag">Create a tag</a></li>
</ul>
</li>
<li><a class="reference internal" href="#release-procedure">Release Procedure</a></li>
<li><a class="reference internal" href="#creating-a-macos-x-installer-on-a-dmg">Creating a MacOS X Installer on a DMG</a></li>
</ul>
</li>
<li><a class="reference internal" href="#future-directions">Future directions</a></li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>

<footer class="footer">
  <p class="pull-right">
    <a href="http://github.com/astropy/astropy/tree/v0.2.1/docs/development/building_packaging.rst">Edit This Page on Github</a> &nbsp;
    <a href="../_sources/development/building_packaging.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2011-2013, The Astropy Developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3+. &nbsp;
    Last built 03 Apr 2013. <br/>
  </p>
</footer>
 <!-- End original user content -->


<br>
<br>
<br>


<style type="text/css">
  .rtd-badge {
    position: fixed;
    display: block;
    bottom: 5px;
    height: 40px;
    text-indent: -9999em;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
    -moz-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
    -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 rgba(255, 255, 255, 0.2) inset;
  }
  #version_menu {
    position: fixed;
    display: none;
    bottom: 11px;
    right: 166px;
    list-style-type: none;
    margin: 0;
  }
  .footer_popout:hover #version_menu {
    display: block;
  }
  #version_menu li {
    display: block;
    float: right;
  }
  #version_menu li a {
    display: block;
    padding: 6px 10px 4px 10px;
    margin: 7px 7px 0 0;
    font-weight: bold;
    font-size: 14px;
    height: 20px;
    line-height: 17px;
    text-decoration: none;
    color: #fff;
    background: #8ca1af url(../images/gradient-light.png) bottom left repeat-x;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    box-shadow: 0 1px 1px #465158;
    -moz-box-shadow: 0 1px 1px #465158;
    -webkit-box-shadow: 0 1px 1px #465158;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
  }
  #version_menu li a:hover {
    text-decoration: none;
    background-color: #697983;
    box-shadow: 0 1px 0px #465158;
    -moz-box-shadow: 0 1px 0px #465158;
    -webkit-box-shadow: 0 1px 0px #465158;
  }
  .rtd-badge.rtd {
    background: #3b4449 url(//media.readthedocs.org//images/badge-rtd.png) scroll 0px -46px no-repeat;
    border: 1px solid #282E32;
    width: 41px;
    right: 5px;
  }
  .footer_popout:hover .rtd-badge.rtd {
    background-position: top left;
    width: 160px;
  }
  .rtd-badge.revsys { background: #465158 url(//media.readthedocs.org//images/badge-revsys.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 290px;
    right: 173px;
  }
  .rtd-badge.revsys-inline-sponsored {
    position: inherit;
    margin-left: auto;
    margin-right: 175px;
    margin-bottom: 5px;
    background: #465158 url(//media.readthedocs.org//images/badge-revsys.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 290px;
    right: 173px;
  }
  .rtd-badge.revsys-inline {
    position: inherit;
    margin-left: auto;
    margin-right: 175px;
    margin-bottom: 5px;
    background: #465158 url(//media.readthedocs.org//images/badge-revsys-sm.png) top left no-repeat;
    border: 1px solid #1C5871;
    width: 205px;
    right: 173px;
  }

</style>
<div class="rtd_doc_footer">
  <div class="footer_popout">
    <a href="//readthedocs.org/projects/astropy/?fromdocs=astropy" class="rtd-badge rtd"> Brought to you by Read the Docs</a>
    <ul id="version_menu">
      
        <li><a href="/en/latest/">latest</a></li>
      
        <li><a href="/en/add-mpl-to-rtd-pip-req/">add-mpl-to-rtd-pip-req</a></li>
      
        <li><a href="/en/v0.2.1/">v0.2.1</a></li>
      
        <li><a href="/en/v0.2/">v0.2</a></li>
      
        <li><a href="/en/v0.1/">v0.1</a></li>
      
    </ul>
  </div>
</div>
<!-- RTD Analytics Code -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17997319-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


<!-- User Analytics Code -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30968842-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



  </body>
</html>